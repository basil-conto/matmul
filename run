#!/bin/sh

# ------------------------------------------------------------------------------
# Convenience build script for the MatMul matrix multiplicaton program.
#
# Copyright (c) 2015 by its authors.
#
# This code is distributed under the BSD3 license. See AUTHORS, LICENSE.
# ------------------------------------------------------------------------------

# VARIABLES --------------------------------------------------------------------

TARGET='./build/matmul'
cppflag=''

USAGE=\
"NAME
    run - convenience build script for the MatMul program.

SYNOPSIS
    ./run [-d] <A nrows> <A ncols> <B nrows> <B ncols>
    ./run -c
    ./run -h

DESCRIPTION
    Runs the MatMul matrix multiplication program, optionally in debug mode,
    with the given matrix dimensions.

OPTIONS
    -c, --clean
        Invoke 'make clean'.

    -d, --debug
        Run in debug mode, printing the elements of the input and resultant
        matrices.

    -h, --help
        Print this help message."

# FUNCTIONS --------------------------------------------------------------------

# Prints the first given argument, followed by the script's usage, before
# exiting unsuccessfully.
print_exit() {
  echo "$1"
  echo ""
  echo "$USAGE"
  exit 1
}

# Exits unsuccessfully if any of the given arguments are no valid matrix
# dimensions, i.e. non-negative integers consisting solely of the digits 0-9.
assert_dimens() {
  for dimen in "$@"; do
    case $dimen in
      '' | *[!0-9]*)
        print_exit "Invalid matrix dimension: $dimen"
        ;;
      *)
        ;;
    esac
  done
}

# Invokes 'make', with preprocessor flags determined by the CPPGLAG variable,
# before running the target with the given arguments.
run_with() {
  make clean && make CPPFLAGS="$cppflag" && $TARGET $@
}

# SCRIPT -----------------------------------------------------------------------

# Check first argument for accepted flags.
case "$1" in
  -d | --debug)
    cppflag='-DDEBUG'
    shift
    ;;
  -c | --clean)
    echo "Running 'make clean'"
    make clean
    exit 0
    ;;
  -h | --help)
    echo "$USAGE"
    exit 0
    ;;
esac

# Check subsequent arguments are matrix dimensions before building and running
# the target.
case $# in
  1)
    assert_dimens $1
    run_with      $1 $1 $1 $1
    ;;
  4)
    assert_dimens $@
    run_with      $@
    ;;
  *)
    print_exit 'Expected 1 or 4 matrix dimensions.'
    ;;
esac
